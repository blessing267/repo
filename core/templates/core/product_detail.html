{% extends 'core/base.html' %}
{% load i18n %}

{% block content %}
<div class="container my-4">
    <div class="card shadow-sm">
        <div class="row g-0">
            <div class="col-md-4 text-center p-3">
                {% if product.image %}
                    <img src="{{ product.image.url }}" class="img-fluid rounded" alt="{{ product.title }}">
                {% else %}
                    <img src="https://via.placeholder.com/300x200.png?text=No+Image" class="img-fluid rounded" alt="No image available">
                {% endif %}
            </div>

            <div class="col-md-8">
                <div class="card-body">
                    <h2 class="card-title">{{ product.title }}</h2>
                    <p class="card-text"><strong>{% trans "Price" %}:</strong> ₦{{ product.price }}</p>
                    <p class="card-text"><strong>{% trans "Quantity" %}:</strong> {{ product.quantity }}</p>
                    <p class="card-text"><strong>{% trans "Location" %}:</strong> {{ product.city }}, {{ product.state }}</p>
                    <p class="card-text"><strong>{% trans "Category" %}:</strong> {{ product.category }}</p>
                    <p class="card-text"><strong>{% trans "Description" %}:</strong> {{ product.description }}</p>
                    <p class="card-text">
                        <small class="text-muted">
                            {% trans "Posted by" %}: {{ product.farmer.username }} 
                            {% trans "on" %} {{ product.date_posted|date:"M d, Y - H:i A" }}
                        </small>
                    </p>

                    <!-- PRICE HISTORY CHART -->
                    <h3 class="mt-4">Price Over Time</h3>
                    <canvas id="priceChart" width="400" height="200"></canvas>
                </div>

                <!-- Load Chart.js at the end of the template -->
                <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
                <script>
                    const ctx = document.getElementById('priceChart').getContext('2d');
                    const priceChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: [{% for h in history %}"{{ h.date_recorded|date:'M d, Y' }}",{% endfor %}],
                            datasets: [{
                                label: 'Price (₦)',
                                data: [{% for h in history %}{{ h.price }},{% endfor %}],
                                borderColor: 'blue',
                                backgroundColor: 'rgba(0, 123, 255, 0.2)',
                                fill: true,
                                tension: 0.2,
                                pointRadius: 4,
                                pointHoverRadius: 6
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: { display: true },
                                title: {
                                    display: true,
                                    text: 'Price History for {{ product.title }}'
                                }
                            },
                            scales: {
                                x: { title: { display: true, text: 'Date' } },
                                y: { title: { display: true, text: 'Price (₦)' }, beginAtZero: false }
                            }
                        }
                    });
                </script> 
                
                    <!-- Back button (visible to everyone) -->
                    <button type="button" class="btn btn-outline-primary mt-3" onclick="window.history.back();">
                        ← {% trans "Back" %}
                    </button>

                    {% if request.user == product.farmer %}
                        <!-- Farmer who posted the crop -->
                        <div class="mt-3">
                            <a href="{% url 'product_update' product.pk %}" class="btn btn-warning me-2">
                                {% trans "Edit" %}
                            </a>
                            <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#deleteModal">
                                {% trans "Delete" %}
                            </button>
                        </div>

                    {% elif request.user.profile.role == 'buyer' %}
                        <!-- Buyer (not the farmer) -->
                        <a href="{% url 'product_list' %}" class="btn btn-outline-primary mt-3">
                            {% trans "Go to Marketplace" %} →
                        </a>
                        <a href="{% url 'send_message' %}" class="btn btn-outline-primary mt-3">
                            {% trans "Message Farmer" %}
                        </a>

                    {% elif request.user.profile.role == 'farmer' %}
                        <!-- Farmer who did NOT post -->
                        <a href="{% url 'product_create' %}" class="btn btn-outline-primary mt-3">
                            {% trans "Post Product" %} →
                        </a>

                    {% endif %}
                </div>

                <!--  Delete Confirmation Modal --> 
                <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content shadow-lg">
                            <div class="modal-header bg-danger text-white">
                                <h5 class="modal-title fw-bold" id="deleteModalLabel"> {% trans "Delete Crop Post" %}</h5> 
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body text-center">
                                <p class="mb-3">{% trans "Are you sure you want to delete this post?" %}</p>
                                <h6 class="fw-bold">{{ product.title }}</h6>
                            </div>
                            <div class="modal-footer">
                                <form method="POST" action="{% url 'product_delete' product.pk %}">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-danger"> {% trans "Yes, Delete" %}</button> 
                                </form>
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"> {% trans "Cancel" %}</button> 
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
